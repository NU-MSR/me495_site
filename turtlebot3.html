<!-- Generated with pandoc -D html
Modified by Matthew Elwin.
-->
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
<meta name="author" content="Matthew Elwin" />
<title>TurtleBot3 Quickstart</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
</style>
<!--[if lt IE 9]>
<script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
<![endif]-->
<style type="text/css">
/*
Matthew Elwin
css for the nume template for making websites

Contains code modified from with https://gist.github.com/killercup/5917178
Mostly using the aesthetics from above, but added a table of contents menu to the left.
When printing, the menu will be hidden

*/


nav#TOC{
    width: 20%;
    height: 100%;
    position:fixed!important;
    z-index:1;
    overflow:auto;
    padding-right: 2em;
}

.home_up{
    position: fixed;
    right: 0.25em;
    top: 0.25em;
}
.content{
    margin-left: 21%;
    padding-left: 4em;
}

.inner{
    margin: 0 auto;
    min-width: 30em;
    max-width: 50em;
}

.no-foot{
    min-height: 100vh 
}

.container:after,.container:before{content:"";display:table;clear:both}

.footer {
    font-size: 9pt
}

html {
  font-size: 100%;
  overflow-y: scroll;
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
  padding: 0;
}

body {
  font-family: "DejaVu Serif", Georgia, Palatino, 'Palatino Linotype', Times, 'Times New Roman', serif;
  font-size: 12px;
  line-height: 1.7;
  padding: 1em;
  background: #fefefe;
}

a {
  color: #0645ad;
  text-decoration: none;
}

a:visited {
  color: #0b0080;
}

nav a:visited {
    color: #0645ad;
}

a:hover {
  color: #06e;
}

nav a:hover {
    color: #0645ad;
    background: #C3C3DE
}

a:active {
  color: #faa700;
}

a:focus {
  outline: thin dotted;
}

*::-moz-selection {
  background: rgba(255, 255, 0, 0.3);
  color: #000;
}

*::selection {
  background: rgba(255, 255, 0, 0.3);
  color: #000;
}

a::-moz-selection {
  background: rgba(255, 255, 0, 0.3);
  color: #0645ad;
}

a::selection {
  background: rgba(255, 255, 0, 0.3);
  color: #0645ad;
}

p {
  margin: 1em 0;
}

img {
  max-width: 100%;
}

h1, h2, h3, h4, h5, h6 {
  color: #111;
  line-height: 125%;
  margin-top: 1em;
  font-weight: normal;
}

h4, h5, h6 {
  font-weight: bold;
}

h1 {
  font-size: 2.5em;
}

h1.title {
    margin-top: 0em;
    font-size: 3em;
}

h2 {
  font-size: 2em;
}

h3 {
  font-size: 1.5em;
}

h4 {
  font-size: 1.2em;
}

h5 {
  font-size: 1em;
}

h6 {
  font-size: 0.9em;
}

blockquote {
  color: #666666;
  margin: 0;
  padding-left: 3em;
  border-left: 0.5em #EEE solid;
}

hr {
  display: block;
  height: 2px;
  border: 0;
  border-top: 1px solid #aaa;
  border-bottom: 1px solid #eee;
  margin: 1em 0;
  padding: 0;
}

pre, code, kbd, samp {
    color: #000;
    background-color: #f0f0f0;
  border: 1px solid #e1e4e5;
  font-family: monospace, monospace;
  _font-family: 'courier new', monospace;
  font-size: 0.98em;
  line-height: normal;
}

.line-block {
    color: #000;
    background-color: #f0f0f0;
    border: 1px solid #e1e4e5;
}
/* this style is used for inline code blocks 
it is overwridden when inside a pre format block*/
code {
    padding: 0 5px;
    white-space: nowrap;
    font-size: 85%
}

pre {
  white-space: pre;
  white-space: pre-wrap;
  word-wrap: break-word;
}

pre code {
    padding: 0 0;
    white-space: inherit;
    border: 0
}

b, strong {
  font-weight: bold;
}

dfn {
  font-style: italic;
}

ins {
  background: #ff9;
  color: #000;
  text-decoration: none;
}

mark {
  background: #ff0;
  color: #000;
  font-style: italic;
  font-weight: bold;
}

sub, sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}

sup {
  top: -0.5em;
}

sub {
  bottom: -0.25em;
}

ul, ol {
  margin: 1em 0;
  padding: 0 0 0 2em;
}

li > ul, li > ol {
    margin: 0 0;
}

nav ul, nav ol {
    list-style: none;
    padding: 0 0 0 0;
}

/* make the top level list item in table of contents not indent*/
nav li > ul, nav li > ol {
    list-style: none;
    padding: 0 0 0 2em;
}

li p:last-child {
  margin-bottom: 0;
}

ul ul, ol ol {
  margin: .3em 0;
}

dl {
  margin-bottom: 1em;
}

dt {
  font-weight: bold;
  margin-bottom: .8em;
}

dd {
  margin: 0 0 .8em 2em;
}

dd:last-child {
  margin-bottom: 0;
}

img {
  border: 0;
  -ms-interpolation-mode: bicubic;
  vertical-align: middle;
}

figure {
  display: block;
  text-align: center;
  margin: 1em 0;
}

figure img {
  border: none;
  margin: 0 auto;
}

figcaption {
  font-size: 0.8em;
  font-style: italic;
  margin: 0 0 .8em;
}

table {
  margin-bottom: 2em;
  border-bottom: 1px solid #ddd;
  border-right: 1px solid #ddd;
  border-spacing: 0;
  border-collapse: collapse;
}

table th {
  padding: .2em 1em;
  background-color: #eee;
  border-top: 1px solid #ddd;
  border-left: 1px solid #ddd;
}

table td {
  padding: .2em 1em;
  border-top: 1px solid #ddd;
  border-left: 1px solid #ddd;
  vertical-align: top;
}

.author {
  font-size: 1.2em;
}

/* When the screen gets too narrow, hide the toc*/
@media only screen and (max-width: 768px) {
    nav {
        visibility: hidden
    }
    .content {
        margin-left: 0;
    }
}

@media only screen and (min-width: 480px) {
  body {
      font-size: 14px;
  }
}
@media only screen and (min-width: 768px) {
  body {
    font-size: 16px;
  }
}
@media print {
  * {
    background: transparent !important;
    color: black !important;
    filter: none !important;
    -ms-filter: none !important;
  }

  nav {
      visibility: hidden;
  }

  .content{
      margin-left: 0%;
      padding-left: 10px;
  }

  body {
    font-size: 10pt;
    max-width: 100%;
  }

  a, a:visited {
    text-decoration: underline;
  }

  hr {
    height: 1px;
    border: 0;
    border-bottom: 1px solid black;
  }

  a[href]:after {
    content: " (" attr(href) ")";
  }

  abbr[title]:after {
    content: " (" attr(title) ")";
  }

  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after {
    content: "";
  }

  pre, blockquote {
    border: 1px solid #999;
    padding-right: 1em;
    page-break-inside: avoid;
  }

  tr, img {
    page-break-inside: avoid;
  }

  img {
    max-width: 100% !important;
  }

  @page :left {
    margin: 15mm 20mm 15mm 10mm;
}

  @page :right {
    margin: 15mm 10mm 15mm 20mm;
}

  p, h2, h3 {
    orphans: 3;
    widows: 3;
  }

  h2, h3 {
    page-break-after: avoid;
  }
}


</style> 
</head>
<body>

<!-- Sidebar for table of contents -->
<nav id="TOC" role="doc-toc">
<h3>Table of Contents</h3>
<ul>
<li><a href="#powering-the-turtlebot">Powering the Turtlebot</a></li>
<li><a href="#setup">Setup</a>
<ul>
<li><a href="#network-instructions">Network Instructions</a></li>
<li><a href="#firmware-setup">Firmware Setup</a></li>
<li><a href="#first-moves">First Moves</a></li>
<li><a href="#ros-master-networking">ROS Master Networking</a></li>
<li><a href="#final-steps">Final Steps</a></li>
</ul></li>
<li><a href="#ubuntu-server-setup">Ubuntu Server Setup</a>
<ul>
<li><a href="#initial-setup">Initial Setup</a></li>
<li><a href="#after-login">After Login</a></li>
<li><a href="#ros-installation.">Ros installation.</a></li>
<li><a href="#udev-rules">Udev Rules</a></li>
<li><a href="#stock-firmware">Stock Firmware</a></li>
<li><a href="#loader.sh">loader.sh</a></li>
<li><a href="#create-the-turtlebot-image">Create the turtlebot image</a></li>
<li><a href="#other-techniques">Other Techniques</a></li>
</ul></li>
<li><a href="#resources">Resources</a></li>
</ul>
</nav>

<nav class="home_up">
  <a href="index.html">Home</a>
</nav>
<div class="content">
  <div class="inner">
    <div class="no-foot">
<!-- Put the header to the right of the table of contents -->
<header id="title-block-header">
<h1 class="title">TurtleBot3 Quickstart</h1>
</header>

<!-- The main content of the file -->
<h1 id="powering-the-turtlebot">Powering the Turtlebot</h1>
<ol>
<li>The Turtlebot can be powered from a battery, or directly from the wall charger, which gets plugged into the OpenCR board
<ul>
<li><strong>IMPORTANT</strong> Always make sure the battery is unplugged prior to powering from the wall charger</li>
<li><strong>IMPORTANT</strong> Never have the battery and wall charger powering the robot simultaneously</li>
</ul></li>
<li>When the battery voltage drops below a threshold, the turtlebot will issue a low-battery warning sound
<ul>
<li><strong>IMPORTANT</strong> When the battery voltage is low, stop using the turtlebot and charge the battery. Otherwise you can permanently damage the battery.</li>
</ul></li>
<li>Do not use the PincherX 100 power brick with the turtlebot3
<ul>
<li>It has the same plug but is rated for significantly less power.</li>
</ul></li>
<li>I like to test most of the software with the turtlebot3 powered from the wall and up on a block so that the wheels don't touch the ground.
<ul>
<li>This method increases development speed because charging the batteries or chasing the turtlebot3 around the room both take time.</li>
<li>However, the odometry of the <code>stock</code> turtlebot3 depends solely on the IMU, therefore if it is up on blocks and you turn, the odometry will be incorrect.
<ul>
<li>In my opinion this is an odd choice but I have not done experiments comparing its accuracy with wheel odometry</li>
<li>If using the <code>nuturtle</code> firmware (e.g., those in ME495 Sensing Navigation and Machine Learning for Robotics) then odometry relies on encoders.</li>
</ul></li>
</ul></li>
</ol>
<h1 id="setup">Setup</h1>
<p>I have created a custom <code>turtlebot3</code> image for you to use for class.</p>
<ol>
<li><p>Closely follow all turtlebot3 assembly instructions.</p></li>
<li><p>Install <code>gdown</code> to download large google drive files: <code>pip3 install gdown</code></p></li>
<li><p>Install zstd: <code>sudo apt install zstd</code> (a compression/decompression tool)</p></li>
<li><p>Download the image file <code>gdown "https://drive.google.com/uc?id=1HYFx_IqGWTO7OJLh9MaZyw9viLNnyJH4" -O ~/turtlebot.img.zst</code></p>
<ul>
<li>If gdown does not work you can just navigate to <a href="https://drive.google.com/uc?id=1HYFx_IqGWTO7OJLh9MaZyw9viLNnyJH4">https://drive.google.com/uc?id=1HYFx_IqGWTO7OJLh9MaZyw9viLNnyJH4</a> and download the file</li>
</ul></li>
<li><p>Insert the SD card into your computer</p>
<ul>
<li>Use <code>lsblk</code> to see which device it is (e.g., <code>/dev/mmcblk0</code> )</li>
<li>Insert and remove to figure out the device. We will pretend it is <code>/dev/mmcblk0</code> from now on.</li>
<li>Dell XPS 13 users: the SD card slot is tricky, use your finger to push it in until you feel a click. The card should not be sticking out more than a millimeter from the body of the computer if it is inserted properly.</li>
</ul></li>
<li><p>Decompress the image to the SD card:</p>
<pre><code>sudo chown $USER:$USER /dev/mmcblk0
zstd -d turtlebot.img.zst -o /dev/mmcblk0
sync
</code></pre>
<ul>
<li>This takes some time, SD cards are slow. Be patient, if you do not wait for the sync command to complete you can corrupt the SD card image.</li>
</ul></li>
<li><p>Next, you should expand the filesystem of the system partition to match the size of the SD card:</p>
<pre><code>echo &quot;- +&quot; | sudo sfdisk -N 2 /dev/mmcblk0 --force
</code></pre></li>
<li><p>Next, remove the SD card and reinsert.</p>
<pre><code>sudo umount /dev/mmcblk0p2
sudo e2fsck -f /dev/mmcblk0p2
sudo resize2fs /dev/mmcblk0p2
</code></pre></li>
<li><p>Remove the SD card and reinsert it. The filesystem should now be mounted at <code>/media/$USER/writable</code></p>
<ul>
<li>If not, manually mount the partition <code>mount /dev/mmcblk0p2 /mnt/location/wherever/you/want</code></li>
</ul></li>
<li><p>Edit <code>/media/$USER/writable/etc/hostname</code> and change the hostname to something unique (all lowercase no spaces or special characters)</p>
<ul>
<li>I refer to the name as <code>turtlebot</code> throughout these instructions but you should substitute with your name</li>
<li>You may need to edit this file as <code>root</code></li>
</ul></li>
<li><p>Edit <code>/media/$USER/writable/etc/NetworkManager/system-connections/Hotspot.nmconnection</code></p>
<ul>
<li>Replace <code>TurtleWifi</code> with a unique name for your turtlebot's wifi network.</li>
<li>You may need to edit this file as <code>root</code></li>
</ul></li>
<li><p>Edit <code>/media/$USER/writable/etc/systemd/timesyncd.conf</code>. Replace turnpike.local, with the hostname of your computer</p></li>
<li><p>Edit <code>/media/$USER/writable/home/ubuntu/loader.sh</code> and change <code>PC_HOSTNAME</code> to the hostname of your pc</p></li>
<li><p>On your computer <code>sudo apt install avahi-daemon ntp</code></p></li>
<li><p>Insert the <code>sdcard</code> into the turtlebot and turn the turtlebot on. You will now connect to it and run some commands</p></li>
</ol>
<h2 id="network-instructions">Network Instructions</h2>
<ol>
<li>Connect to <code>TurtleWifi</code> network
<ul>
<li>Remember to substitute TurtleWifi with whatever you named the Wifi</li>
<li>You will lose internet on your laptop while connected to the turtlebot if you are relying on Wifi internet</li>
</ul></li>
<li>Make sure you can <code>ping turtlebot.local</code>
<ul>
<li>Remember to substitute turtlebot with whatever you named the <code>turtlebot</code></li>
</ul></li>
<li>Create an rsa ssh key with no password, specifically for the turtlebot: <code>ssh-keygen -t rsa -f ~/.ssh/id_turtle -N ''</code>
<ul>
<li><a href="https://wiki.archlinux.org/index.php/SSH_keys">More information about SSH keys</a></li>
<li>If you already have one you do not need to redo this step</li>
</ul></li>
<li>Copy your ssh key to the robot.
<ul>
<li><code>ssh-copy-id -i ~/.ssh/id_turtle.pub ubuntu@turtlebot.local</code></li>
</ul></li>
<li>SSH into the robot. If your key was setup correctly you should not need to enter a password
<ul>
<li><code>ssh ubuntu@turtlebot.local</code></li>
<li>If, in the previous step, you were prompted for a password, you may need to add the ssh key on your machine to have it unlocked automatically.
<ul>
<li><p>To use an ssh key in a given session</p>
<pre><code>eval $(ssh-agent)
ssh-add ~/.ssh/id_turtle
</code></pre></li>
<li><p>If you are using the Gnome desktop (default desktop on Ubuntu), the key should be unlocked automatically: logging out and logging in again may help.</p></li>
</ul></li>
</ul></li>
<li>On You can now use <code>sudo nmtui</code> to connect the <code>turtlebot</code> to your home (non-Northwestern) wifi router:
<ul>
<li>Go into Edit connection. Name the Profile "Home" and the Device is "wlan0"</li>
<li>Enter Your SSID and set Security to your network security type.
<ul>
<li>The <code>raspberry pi</code> does not have 5 ghz wifi, so you will need to connect to a 2.4 Ghz Network</li>
</ul></li>
<li>After you are done editing, exit <code>nmtui</code></li>
<li>Set the priority of this network so that it supersedes the access point: <code>ubuntu@turtlebot$ sudo nmcli c mod Home connection.autoconnect-priority 10</code></li>
<li>Reboot the turtlebot.
<ul>
<li>If all went well it should now be on your <code>wifi</code> network and you should be able to ping it.</li>
<li>If the connection failed, you should be able to connect to <code>TurtleWifi</code></li>
<li>It might take a few minutes for the <code>turtlebot.local</code> name to resolve properly on your network</li>
</ul></li>
</ul></li>
<li>If you are in the lab, your turtlebot will automatically connect to the TURTLENET network. You can connect to that as well (password is NU-TURTLE) and then work from there.</li>
</ol>
<p>9 See <a href="https://nu-msr.github.io/hackathon_site/linux_interactive.html#networking">Networking</a> for a very brief explanation of networking.</p>
<h2 id="firmware-setup">Firmware Setup</h2>
<ol>
<li>SSH into the turtlebot and execute the following commands on the turtlebot to install the opencr firmware:
<ul>
<li><p>Stock firmware (if not in ME495 Sensing Navigation and Machine Learning for Robotics)</p>
<pre><code>cd ~/opencr_update
./update.sh /dev/ttyACM0 burger.opencr
</code></pre></li>
</ul>
<ul>
<li><p>Custom (if in ME495 Sensing Navigation and Machine Learning For Robotics)</p>
<pre><code>cd ~/opencr_update
./update.sh /dev/ttyACM0 raw-burger.opencr
</code></pre></li>
</ul></li>
</ol>
<h2 id="first-moves">First Moves</h2>
<ol>
<li>ssh into the <code>turtlebot</code> and run <code>roslaunch turtlebot3_bringup turtlebot3_robot.launch</code>
<ul>
<li>This launchfile starts everything that is needed to control the turtlebot</li>
<li>Essentially it is a node that communicates with the low-level controller and converts between low-level control and sensing information to ROS messages.</li>
</ul></li>
<li>From another window, ssh into the turtlebot, run <code>rostopic pub /sound turtlebot3_msgs/Sound "value: 2"</code>
<ul>
<li>This is the low-battery sound</li>
<li>If you ever hear this sound when not purposely sending this message, stop and charge the battery immediately</li>
<li>Try out some other sound values (see the meaning <a href="http://docs.ros.org/noetic/api/turtlebot3_msgs/html/msg/Sound.html">Sound.msg</a>)</li>
</ul></li>
<li>Put the turtlebot3 up on a block so that the wheels are slightly above the ground (The RealSense box works well for this)
<ul>
<li>If using stock firmware: Try publishing some <code>cmd_vel</code> messages and experiment with how the wheels move</li>
<li>If using custom firmware: Try publishing some <code>wheel_cmd</code> messages and experimenting with how the wheels move</li>
</ul></li>
<li>End the <code>roslaunch</code></li>
</ol>
<h2 id="ros-master-networking">ROS Master Networking</h2>
<ul>
<li>We will be running <code>rosmaster</code> on your PC and having the turtlebot connect to it.</li>
<li>The <a href="./networking.html">Networking Lecture</a> has more details about various ROS networking setups.</li>
</ul>
<ol>
<li><p>On the turtlebot edit <code>~/.bashrc</code> (e.g., <code>nano ~/.bashrc</code>) and add the following lines to the end(where <code>&lt;hostname&gt;</code> is the hostname of your computer. Be sure to replace <code>turtlebot</code> with the name of your turtlebot)</p>
<ul>
<li><p>The lines come after <code>source ~/ws/devel/setup.bash</code></p>
<pre><code>export ROS_MASTER_URI=http://&lt;hostname&gt;.local:11311
export ROS_HOSTNAME=turtlebot.local
</code></pre></li>
</ul></li>
<li><p>Close all the ssh sessions on the turtlebot</p></li>
<li><p>In a new ssh session, try to run <code>roslaunch turtlebot3_bringup turtlebot3_robot.launch</code></p>
<ul>
<li>Make sure you are not running <code>roscore</code> on your computer.</li>
<li>This command <strong>should fail</strong> saying something like <code>RLException: ERROR: unable to contact ROS master at [...]</code></li>
<li>The error message shows that <code>roslaunch</code> is now trying to connect to a <code>rosmaster</code> running on your computer</li>
</ul></li>
<li><p>In the <code>~/.bashrc</code> on your computer (the REMOTE PC) add the following lines to your <code>.bashrc</code></p>
<pre><code>export ROS_MASTER_URI=http://&lt;hostname&gt;.local:11311
export ROS_HOSTNAME=&lt;hostname&gt;.local
</code></pre>
<p>hostname is the <code>hostname</code> of your computer</p></li>
<li><p>On your PC (the REMOTE PC) run <code>roscore</code></p></li>
<li><p>Follow the <em>First Moves</em> section again and make sure everything still works</p></li>
</ol>
<h2 id="final-steps">Final Steps</h2>
<ol>
<li>You should now be able to use your turtlebot as specified in the <a href="https://emanual.robotis.com/docs/en/platform/turtlebot3/overview/">Official Manual</a>
<ul>
<li>(Only if you installed the <code>stock firmware</code>)</li>
<li>You will be making it work as part of the ME495 Sensing Navigation and Machine Learning Course</li>
</ul></li>
</ol>
<h1 id="ubuntu-server-setup">Ubuntu Server Setup</h1>
<p><strong>IMPORTANT NOTE</strong> You do not need to follow these instructions: they are here so you can see how I created the image you downloaded (<code>turtlebot.img.zst</code>).</p>
<h2 id="initial-setup">Initial Setup</h2>
<ol>
<li><p>If you are a student, you do not need to follow these instructions. This is how I created <code>turtlebot.img.zst</code></p></li>
<li><p>Download <a href="https://ubuntu.com/download/raspberry-pi">Ubuntu Server 20.04.1 for Raspberry Pi</a></p>
<ul>
<li><code>curl -L "https://cdimage.ubuntu.com/releases/20.04.1/release/ubuntu-20.04.1-preinstalled-server-armhf+raspi.img.xz" &gt; /tmp/raspi.img.xz</code></li>
</ul></li>
<li><p>Extract the image <code>unxz -T0 /tmp/raspi.img.xz</code></p></li>
<li><p>Write the image to the sdcard.</p>
<ul>
<li>Use <code>lsblk</code> to find the sdcard device (i.e., <code>/dev/mmcblk0</code>)</li>
<li><code>chown $USER:$USER /dev/mmcblk0</code> so you don't need to be root</li>
<li>If the devices are mounted on <code>/media/username/writable</code> or <code>/media/username/system-boot</code>, unmount them</li>
<li><code>dd bs=4M if=/tmp/raspi.img of=/dev/mmcblk0 status=progress conv=fsync</code></li>
<li>This takes a while since SD cards are slow.</li>
</ul></li>
<li><p>Follow the <a href="https://ubuntu.com/tutorials/how-to-install-ubuntu-on-your-raspberry-pi#3-wifi-or-ethernet">instructions</a> to <code>ssh</code> into the raspberry pi or access its console</p>
<ul>
<li>It is easiest to plug an ethernet cable in and have a router running <code>openwrt</code>, then just <code>ssh ubuntu@ubuntu</code></li>
</ul></li>
<li><p>Change the password to <code>turtlebot</code></p></li>
</ol>
<h2 id="after-login">After Login</h2>
<ol>
<li><p>Set the hostname: <code>echo "turtlebot" | sudo tee /etc/hostname</code></p></li>
<li><p><code>sudo apt update</code></p></li>
<li><p><code>sudo apt full-upgrade</code></p></li>
<li><p><code>sudo apt install network-manager gdb</code></p></li>
<li><p>Uninstall cruft</p>
<pre><code>sudo apt remove cloud-init unattended-upgrades ubuntu-server \
apport-symptoms cloud-guest-utils cloud-initramfs-copymods \
cloud-initramfs-dyn-netconf update-notifier-common \
lvm2 sosreport netplan.io

</code></pre>
<ul>
<li><code>sudo systemctl disable --now motd-news.timer  apt-daily-upgrade.timer apt-daily.timer</code></li>
<li><code>sudo rm -rf /etc/cloud /etc/netplan/</code></li>
<li><code>sudo apt-mark manual $(sudo apt-get -s autoremove 2&gt;/dev/null | awk '/^Remv / { print $2 }')</code></li>
</ul></li>
<li><p>Setup the wifi connections:</p>
<ul>
<li>Copy <code>Hotspot.nmconnection</code> to <code>/etc/NetworkManager/system-connections</code> and <code>chmod 600</code></li>
<li>Copy <code>TURTLENET.nmconnection</code> to <code>/etc/NetworkManager/system-connections</code> and <code>chmod 600</code></li>
</ul></li>
<li><p><code>sudo dpkg-reconfigure tzdata</code> to change the timezone as appropriate</p></li>
<li><p>disable motd: Edit <code>/etc/default/motd-news</code> setting <code>ENABLED=0</code> <code>sudo chmod -x /etc/update-motd.d/*</code></p></li>
<li><p>Remove snaps:</p>
<pre><code>sudo snap remove lxd
sudo snap remove core18
sudo snap remove snapd
sudo apt remove snapd
sudo apt-mark manual squashfs-tools
</code></pre></li>
<li><p>Disable systemd-networkd <code>sudo systemctl disable systemd-networkd</code></p></li>
<li><p><code>sudo touch /etc/NetworkManager/conf.d/10-globally-manged-devices.conf</code></p>
<ul>
<li>let network manager manage everything</li>
</ul></li>
</ol>
<h2 id="ros-installation.">Ros installation.</h2>
<p>Install ros: <a href="http://wiki.ros.org/Installation/UbuntuARM">http://wiki.ros.org/Installation/UbuntuARM</a> (as of 12/5/2019)</p>
<pre><code>sudo sh -c &#39;echo &quot;deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main&quot; &gt; /etc/apt/sources.list.d/ros-latest.list&#39;

sudo apt-key adv --keyserver &#39;hkp://keyserver.ubuntu.com:80&#39; --recv-key C1CF6E31E6BADE8868B172B4F42ED6FBAB17C654
sudo apt update
sudo apt install ros-noetic-ros-base 
sudo apt install ros-noetic-hls-lfcd-lds-driver \
                 ros-noetic-turtlebot3-msgs \
                 ros-noetic-turtlebot3 \
                 ros-noetic-rosserial-python \
                 ros-noetic-joint-state-publisher \
                 ros-noetic-robot-state-publisher \
                 ros-noetic-slam-toolbox \
                 ros-noetic-tf \
                 python3-rosdep \
                 build-essential \
                 avahi-daemon
sudo rosdep init
rosdep update
echo &quot;source /opt/ros/noetic/setup.bash&quot; &gt;&gt; ~/.bashrc
source /opt/ros/noetic/setup.bash
</code></pre>
<h2 id="udev-rules">Udev Rules</h2>
<p>Create and install the udev rules</p>
<pre><code>rosrun turtlebot3_bringup create_udev_rules
sudo udevadm control --reload
sudo udevadm trigger
</code></pre>
<h2 id="stock-firmware">Stock Firmware</h2>
<p>The firmware for the motor control drivers can be compiled on the host computer according to the instructions <a href="https://emanual.robotis.com/docs/en/platform/turtlebot3/opencr_setup/#opencr-setup">here</a></p>
<ul>
<li>Setup the IDE</li>
<li>Clone <code>https://github.com/ME495-Navigation/OpenCR</code>
<ul>
<li>For stock firmware, checkout the branch <code>noetic</code></li>
<li>For custom firmware checkout the branch <code>raw-mode</code></li>
<li>You will want to build both firmware versions and make them available</li>
<li>To build the custom raw-mode firmware, make sure that you have a workspace with <code>https://github.com/ME495-Navigation/nuturtlebot.git</code> sourced</li>
</ul></li>
<li>Delete <code>~/.arduino15/packages/OpenCR/hardware/OpenCR/&lt;version&gt;/libraries</code> and replace with a symlink to the <code>OpenCR/arduino/opencr_arduino/opencr/libraries</code></li>
<li>Make sure the OpenCR board is selected under tools and that you open the firmware via File/examples/turtlebot3/turtlbot3<sub>burger</sub>/turtlebot3<sub>core</sub></li>
<li>After compiling the sketch the binary will be in <code>/tmp/arduino_build_&lt;number&gt;/turtlebot3_core.ino.bin</code>
<ul>
<li>It is important that we actually are compiling the libraries from the git repository and not the libraries that were installed with the board support package</li>
</ul></li>
<li>Run <code>~/OpenCR/arduino/opencr_develop/opencr_ld_shell/opencr_ld_shell_x86 make /tmp/arduino_build_&lt;number&gt;/turtlebot3_core.ino.bin burger NU-MSR</code>
<ul>
<li>This will create a file called <code>burger.opencr</code></li>
<li>For the custom firmware, change to burger to raw-burger and NU-MSR to NU-RAW (this will create a raw-burger.opencr file)</li>
</ul></li>
<li>Let <code>$tools = OpenCR/arduino/opencr_develop/opencr_ld_shell</code>
<ul>
<li>Copy <code>burger.opencr</code>, <code>$tools/update.sh</code>, <code>$tools/opencr_ld_shell_arm</code> to <code>/home/ubuntu/opencr_update</code> on the turtlebot
<ul>
<li>rename <code>opencr_ld_shell_arm</code> to <code>opencr_ld_shell</code></li>
</ul></li>
</ul></li>
<li>Copy the nuturtlebot repository to a ros workspace on the turtlebot, compile it, and source it in bashrc</li>
</ul>
<h2 id="loader.sh">loader.sh</h2>
<ul>
<li>copy loader.sh to the home directory. This will be the env-loader script when connecting remotely~. .</li>
<li>touch install/setup.sh as a placeholder</li>
</ul>
<h2 id="create-the-turtlebot-image">Create the turtlebot image</h2>
<ol>
<li>Powerdown the turtlebot, place the sdcard in your PC.</li>
<li>Place in your computer and make sure the partitions are unmounted</li>
<li>Use gparted to resize and shrink the partition to a smaller size</li>
<li>use <code>fdisk -l</code> to see sector size and how many sectors to the end of the last partition</li>
<li>Use <code>dd if=/dev/mmcblk0 of=turtlebot.img bs=SIZE count=COUNT status =progress</code> to copy only the used portion of the disk (the coutn should be the end of the final partition</li>
<li>Save a compressed version of the image (Assuming the image is in <code>/dev/mmcblk0</code>) <code>zstd -22v -T0 --ultra &lt; turtlebot.img &gt; turtlebot.img.zst</code></li>
</ol>
<h2 id="other-techniques">Other Techniques</h2>
<p>You can mount the raspberry pi image on your machine and use qemu to directly run commands from a chroot.</p>
<ol>
<li>Install <code>qemu-user-static</code> and Run the commands with</li>
<li>Make sure <code>systemctl status binfmt</code> is running</li>
<li>Mount the image: <code>sudo losetup -f --show -P raspi.img</code>
<ul>
<li>Based on the loop device returned mount the partition. For example if it is <code>/dev/loop18</code></li>
<li><code>sudo mount /dev/loop18p2 /mnt/raspberrypi</code></li>
</ul></li>
<li><code>sudo cp /usr/bin/qemu-arm-static /mnt/raspberrypi/usr/bin</code></li>
<li><code>PATH=/bin:/usr/bin:/usr/sbin:/sbin sudo chroot  /mnt/raspberrypi bin/bash</code></li>
<li>We can now run the commands and will directly modify the image</li>
</ol>
<h1 id="resources">Resources</h1>
<ul>
<li><a href="http://emanual.robotis.com/docs/en/platform/turtlebot3/overview/">Main turtlebot documentation</a></li>
</ul>
</div>
<div class="footer">
Author: Matthew Elwin.
</div>
</div>
</div>

</body>
</html>
